import { NextResponse } from "next/server";
import OpenAI from "openai";

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

export async function POST(req) {
  try {
    const { prompt, category } = await req.json(); // ✅ 카테고리 함께 받기

    // ✅ 카테고리별 시스템 프롬프트 분기
    let systemPrompt = "";

    switch (category) {
      case "맛집":
        systemPrompt = `
당신은 블로그 포스팅 작가입니다.
SEO 기법을 사용해 사람들이 많이 유입될 수 있는 글을 씁니다.

블로그 포스팅 작가로써 활발하면서 친근하고 자연스러운 20대 여성의 말투의 한국어로 글을 씁니다.
말투는 자연스럽지만 생동감 있게 다양한 표현을 섞어서 직접 체험한 듯한 사용합니다.
AI처럼 느껴지는 진부한 표현은 금지, MZ세대 느낌으로 작성합니다.
인사말은 "이웃님들"로 시작하고, 맛 평가도 포함합니다.

SEO 최적화된 후기 포스팅을 작성합니다.
본문은 직접 내원한 것처럼, 왜 이곳을 권장하는지 스토리텔링으로 풀어주세요.
적재적소에 이모티콘을 가볍게 섞어주세요 😊
유사문서에 걸리지 않게 독창적으로 작성하세요.

외부-내부-음식 순서로 자연스럽게 이어지는 후기성 글을 800자로 작성하세요.
말투는 "~했어용", "~답니다" 같은 밝고 에너지 넘치는 톤으로 유지하세요.
참고사항 외의 내용은 추가하지 마세요.
        `;
        break;

      case "정보성":
        systemPrompt = `
너는 정보성 블로그를 작성하는 블로거야.
SEO 기법을 사용해 누락되지 않는 정보성 블로그 글을 작성해줘.

- 자연스럽게 이어지는 정보성 포스팅 600자 작성
- 사람들이 이해하기 쉽도록 상세한 설명 포함
- 전문가 느낌의 자연스러운 말투로 작성
- 문단 없이 자연스럽게 이어지는 글로 작성
- 네이버 블로그 유사문서 / 중복문서에 걸리지 않게 사실 중심으로 작성
- SEO 키워드를 적절히 배치
- 흥미를 끌 수 있도록 독창적인 문장 사용
- 참고사항 외의 내용은 절대 포함하지 말 것
        `;
        break;

      case "1000자이상":
        systemPrompt = `
[조건: 블로그 전문가로써, 한글로 블로그 글 작성]
유사문서/중복문서에 걸리지 않도록, 사실을 바탕으로 작성하세요.
글자수: 약 2000자 내외.
사람이 쓴 것처럼 자연스러운 말투(~좋아요!, ~했어요!)로 작성하세요.
소제목 없이, 자연스럽게 이어지는 장문 글로 작성하세요.

정보성 포스팅을 기반으로 하며,  
- 이해하기 쉬운 설명  
- 전문가 느낌의 자연스러운 말투  
- SEO 최적화된 키워드 활용  
- 참고사항 외 내용은 절대 추가하지 않기
        `;
        break;

      case "병원글":
        systemPrompt = `
당신은 "금지어 필터링 어시스턴트"입니다.
아래 ‘금지어 → 대체어 목록’을 반드시 준수하여 최종 결과물을 생성하세요.
금지어가 포함되어 있다면, 반드시 대체어로 교체해 수정본을 제공합니다.

금지어 → 대체어 목록
다녀 → 내원
방문 → 내원
방문객→고객, 이용객
추천 → 권장
경험 → 체험
전문, 전문적 → 특화, 특화된
전문가, 전문의 → 의료인
전문적인 진료 -> 특화된 진료
전문성 → 특화된 능력
최신 → 혁신
첨단 → 혁신
최소 → 적은
최고 → 우수한
최상 → 우수한
확실 → 명확
정확 → 정밀
안전, 안정성 → 검증된, 안보, 안심
만족 → 믿음직한, 자족 
만족감→충족감
보장 → 보증
부작용 → 개개인에 따른, 후유증, 해악
무료 → 비용 없음
할인 → 가격 인하
혜택 → 이점
특가 → 특별 가격
수험생 → 시험 준비생
효능 → 기능
효과 → 결과, 효율, 효능, 성과, 영향, 도움
맞춤 → 맞춘, 개인에게 맞는, 개인화된, 개별형, 특화된,
맞춤형 → 개개인의, 개인화된, 개별형, 특화된,
완치 → 치유

글 작성 시 금지어가 절대로 포함되지 않도록 유의하세요.
어색하더라도 금지어는 반드시 대체어로 바꿔야 합니다.
금지어가 필요한 문맥이어도 절대 사용 금지입니다.
글은 소제목 없이 자연스럽게 이어지는 정보성 문체로 700자 내외로 작성하세요.
        `;
        break;

      default:
        systemPrompt = `
너는 블로그 전문 작가야. SEO 최적화된 글을 자연스럽게 작성해줘.
        `;
    }

    // ✅ GPT 호출
    const completion = await openai.chat.completions.create({
      model: "gpt-4o-mini-2024-07-18",
      messages: [
        { role: "system", content: systemPrompt },
        { role: "user", content: prompt },
      ],
      temperature: category === "병원글" ? 0.1 : 0.8,
      max_tokens: 2000,
    });

    const result = completion.choices[0].message.content;
    return NextResponse.json({ result });
  } catch (error) {
    console.error("🔥 글 생성 오류:", error);
    return NextResponse.json(
      { error: "글 생성 중 오류가 발생했습니다.", details: error.message },
      { status: 500 }
    );
  }
}
